# Account Model

This page dives deep into Drift's onchain account structures, focusing on how positions, orders, and collateral are represented and calculated.

## UserAccount structure

The UserAccount is the core trading account. Key fields:

```typescript
{
  authority: PublicKey,           // Wallet that owns this account
  subAccountId: number,            // 0, 1, 2, ... for multiple subaccounts
  perpPositions: PerpPosition[8],  // Up to 8 perp positions
  spotPositions: SpotPosition[8],  // Up to 8 spot positions (deposits/borrows)
  orders: Order[32],               // Up to 32 open orders
  delegate: PublicKey,             // Optional delegate address
  marginTradingEnabled: boolean,   // Can borrow to increase leverage
  idle: boolean,                   // No open positions or orders
  // ... plus many more fields for fees, settled pnl, etc.
}
```

## Position accounting

### PerpPosition

Perp positions track your long/short exposure in a perpetual futures market:

```typescript
{
  marketIndex: number,             // Which perp market (0 = SOL, 1 = BTC, etc.)
  baseAssetAmount: BN,             // Position size (positive = long, negative = short)
  quoteAssetAmount: BN,            // Quote spent/received (for entry price calculation)
  quoteEntryAmount: BN,            // Entry quote amount (for PnL calc)
  openBids: BN,                    // Notional value of open buy orders
  openAsks: BN,                    // Notional value of open sell orders
  settledPnl: BN,                  // Realized PnL that's been settled
  lpShares: BN,                    // If providing liquidity to AMM
  lastCumulativeFundingRate: BN,   // For funding payment tracking
  // ... more fields
}
```

**Entry price** is calculated as `quoteEntryAmount / baseAssetAmount`. **Unrealized PnL** compares current oracle price to entry price.

### SpotPosition

Spot positions are deposits (positive) or borrows (negative):

```typescript
{
  marketIndex: number,             // Which spot market (0 = USDC, 1 = SOL, etc.)
  scaledBalance: BN,               // Balance scaled by cumulative interest
  balanceType: DepositBalance | BorrowBalance,
  openBids: BN,                    // Locked in open buy orders
  openAsks: BN,                    // Locked in open sell orders
  cumulativeDeposits: BN,          // Historical tracking
  // ... more fields
}
```

Interest accrues via the `scaledBalance`, it's multiplied by the market's cumulative deposit/borrow index to get the real balance. This avoids per-user interest calculations onchain.

## Order structure

Orders are stored inline in UserAccount:

```typescript
{
  orderId: number,                 // Auto-incrementing order ID
  userOrderId: number,             // Optional user-assigned ID
  marketIndex: number,
  marketType: PerpMarket | SpotMarket,
  orderType: Limit | Market | TriggerLimit | TriggerMarket | Oracle,
  direction: Long | Short,
  baseAssetAmount: BN,             // Order size
  price: BN,                       // Limit price (if applicable)
  auctionStartPrice: BN,           // JIT auction start price
  auctionEndPrice: BN,             // JIT auction end price
  auctionDuration: number,         // Slots for auction
  slot: BN,                        // Slot when order was placed
  postOnly: boolean,               // Must be maker
  reduceOnly: boolean,             // Only reduce position
  immediateOrCancel: boolean,      // Fill or cancel
  oraclePriceOffset: BN,           // For oracle-offset orders
  // ... more fields
}
```

**Oracle orders** have a price that moves with the oracle: `oraclePrice + oraclePriceOffset`. This lets market makers quote without constantly updating orders.

## Collateral calculation

Your total collateral is calculated across all spot positions:

```
Total Collateral =
  Σ (spot deposits × asset weight)
  - Σ (spot borrows × liability weight)
  + unrealized perp PnL
```

**Asset weights** are less than 1.0 (e.g., SOL might be 0.9) to provide a safety buffer. **Liability weights** are greater than 1.0 (e.g., 1.1) to account for borrowed funds.

**Margin requirement** sums position notional values weighted by initial margin ratios:

```
Margin Requirement = Σ (position notional × initial margin ratio)
```

**Health** = Total Collateral / Margin Requirement. Below 1.0 → liquidation eligible.

## Cross-margin accounting

All subaccounts under the same wallet share collateral:
- Deposits in subaccount 0 can back positions in subaccount 1
- Liquidation considers all subaccounts together
- But subaccounts have separate order books and positions

This is why `switchActiveUser()` in the SDK lets you change which subaccount you're trading with, they all use the same margin pool.

## State transitions

Common account state changes:

**Deposit**:
- Increases spot position scaled balance
- Transfers tokens from wallet to drift token vault

**Place order**:
- Adds Order to orders array
- Increases openBids/openAsks on relevant position
- Locks collateral

**Order fill**:
- Updates baseAssetAmount and quoteAssetAmount on position
- Reduces openBids/openAsks
- Marks order as filled
- Emits OrderFillRecord event

**Settle PnL**:
- Converts unrealized PnL to realized (moves quote from perp position to spot balance)
- Required before withdrawing profits from winning perp positions

## Account size limits

- **8 perp positions** - opening 9th market fails unless you close an existing one
- **8 spot positions** - same limit
- **32 orders** - includes both resting and trigger orders

These limits keep account size manageable and transaction costs predictable.

## Related

- [Program Structure](./program-structure) - Account types and PDAs
- [SDK Internals](./sdk-internals) - How SDK reads and interprets account data
