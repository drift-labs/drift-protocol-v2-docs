# Program Structure

The Drift protocol is a Solana program (smart contract) that manages user accounts, positions, orders, and markets. Understanding the onchain data model helps you work effectively with the SDK and understand how state updates propagate.

## Core accounts

Drift uses several account types, each serving a specific purpose:

### State account

**Single global account** holding protocol-wide configuration:
- Oracle guards (stale price thresholds)
- Fee tiers and parameters
- Sequencer settings
- Protocol admin addresses
- Emergency flags

The State account is a singleton, there's only one per deployment. It's read by almost every instruction to apply protocol-level rules.

### Market accounts

**PerpMarketAccount** (one per perp market):
- AMM parameters (base/quote reserves, sqrt_k)
- Funding rate state
- Oracle source (Pyth, Switchboard, etc.)
- Fee structure
- Open interest and contract tier
- Market status (active, paused, etc.)

**SpotMarketAccount** (one per spot market):
- Deposit/borrow interest rates
- Utilization and optimal utilization targets
- Insurance fund stake
- Oracle source
- Deposit/borrow limits

Markets are identified by numeric indices (market 0, market 1, etc.). The SDK caches market accounts for fast lookups.

### User accounts

**UserAccount** holds all trading state for a specific subaccount:
- Perp positions (market index, base amount, quote entry, last funding index)
- Spot positions (deposits/borrows per market)
- Open orders (up to 32 orders per user)
- Leverage settings and margin trading enabled flag
- Delegates and permissions

Users are PDAs derived from: `[authority, subaccount_id]`. Each wallet can have multiple subaccounts (0, 1, 2...) sharing cross-margin.

**UserStatsAccount** tracks aggregated stats:
- Total fees paid
- Total volume
- Referrer data
- Fuel (maker incentive points)

### Order accounting

Orders are stored directly in UserAccount, not as separate accounts. Each order contains:
- Market index + market type (perp/spot)
- Order type (limit, market, oracle, trigger)
- Direction (long/short)
- Base amount and price
- Order ID and user order ID
- Post-only, reduce-only, immediate-or-cancel flags
- Auction parameters (start/end slot, duration)

When an order fills, it's marked as filled but not immediately removed, this allows tracking order history within the account.

## PDAs (Program Derived Addresses)

Drift extensively uses PDAs for deterministic address generation:

```
User PDA: [b"user", authority.key(), subaccount_id as bytes]
UserStats PDA: [b"user_stats", authority.key()]
PerpMarket PDA: [b"perp_market", market_index as bytes]
SpotMarket PDA: [b"spot_market", market_index as bytes]
```

The SDK provides helpers like `getUserAccountPublicKey()` to derive these addresses without onchain calls.

## Account relationships

```
State (1)
  ├── PerpMarket[0..N]
  ├── SpotMarket[0..M]
  └── Insurance Fund

Wallet
  ├── UserStats (1 per wallet)
  └── UserAccount[0..N] (subaccounts)
        ├── PerpPosition[0..N]
        ├── SpotPosition[0..M]
        └── Order[0..32]
```

## How instructions modify state

When you call an instruction (e.g., `placePerpOrder`), the program:
1. Loads accounts passed in the instruction
2. Validates account ownership and PDAs
3. Loads oracle price data
4. Applies protocol rules from State account
5. Updates UserAccount (adds order, updates positions, etc.)
6. Updates market state if needed (AMM, funding, etc.)
7. Emits event logs for offchain indexing

The SDK handles account passing automatically, you rarely need to manually construct the account list.

## Remaining accounts pattern

Many instructions use "remaining accounts" to dynamically pass oracle, market, and user accounts. This lets a single instruction handle variable market sets without requiring specific account slots. The SDK's `getRemainingAccounts()` method builds this list based on which markets your positions touch.

## Related

- [Account Model](./account-model) - Detailed account structures
- [SDK Internals](./sdk-internals) - How the SDK subscribes to and caches these accounts
