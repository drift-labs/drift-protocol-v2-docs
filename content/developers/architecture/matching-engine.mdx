# Matching Engine & Liquidity

Drift's matching engine determines how taker orders get filled across multiple liquidity sources. Understanding liquidity priority helps you optimize order placement and understand execution quality.

## Liquidity priority

When a taker order arrives, it's matched in this priority order:

**1. JIT Auction** (first 5-10 slots)
   - Market makers compete to fill at best price
   - Multiple makers can participate
   - Dynamic pricing interpolates toward oracle

**2. DLOB (Decentralized Limit Order Book)**
   - Resting limit orders from all users
   - Sorted by price-time priority
   - onchain commitment

**3. AMM (Automated Market Maker)**
   - Fallback liquidity at formula-based price
   - Uses `x * y = k` constant product curve
   - Adjusted by oracle to prevent arbitrage

**4. External fulfillment** (if enabled)
   - Phoenix DEX
   - Serum/OpenBook
   - Jupiter aggregator for spot markets

This waterfall ensures best execution: JIT makers compete for best prices, DLOB provides committed liquidity, and AMM ensures every order can fill.

## JIT auction phase

**Duration**: 5-10 slots (typically)
**Pricing**: Interpolates from start price (oracle ± spread) to end price (oracle)
**Participation**: Market makers submit `placeAndMake` instructions

If the auction fully fills the taker, execution stops here. Otherwise, remaining size moves to DLOB.

## DLOB matching

After JIT auction (or if taker bypasses auction with limit order at DLOB price):

**Price-time priority**:
1. Best price wins (lowest ask for buys, highest bid for sells)
2. If tied on price, earliest order wins
3. Fill up to available liquidity at each price level
4. Walk the book until taker is filled or book exhausted

**Example** (taker buying 10 SOL):
- DLOB has 3 SOL @ $100, 5 SOL @ $100.10, 4 SOL @ $100.20
- Taker fills: 3 @ $100, 5 @ $100.10, 2 @ $100.20 (partial fill at $100.20)

If DLOB doesn't fully fill, remaining size goes to AMM.

## AMM fulfillment

The AMM provides backstop liquidity using a constant-product curve adjusted by oracle price:

```
AMM Price = oracle × (1 + price_impact_from_reserves)

where price_impact depends on:
- Base asset reserves
- Quote asset reserves
- Trade size relative to liquidity
```

**AMM characteristics**:
- Always available (can't be "empty")
- Price degrades with size (larger trades = worse price)
- Oracle arbitrage keeps AMM prices near market
- AMM collects fees that become protocol reserves

Taker pays AMM fees (typically 0.05-0.10%) plus price impact. This makes AMM the most expensive liquidity source, incentivizing JIT/DLOB participation.

## External fulfillment

For spot markets, Drift can route to external DEXs if they offer better prices:

**Phoenix** (Ellipsis Labs):
- High-performance Solana orderbook
- Used for SOL, BTC, ETH spot markets
- Checked before AMM if configured

**Jupiter**:
- Aggregates multiple DEX sources
- Used for long-tail spot markets
- Provides best execution across Solana DeFi

The matching engine checks these sources and routes to whichever offers the best net price after fees.

## Maker vs taker execution

**Makers** (provide liquidity):
- Place post-only limit orders on DLOB
- Earn maker rebates (negative fees, e.g., -0.0025%)
- Orders rest until filled by taker
- Can cancel anytime before fill

**Takers** (remove liquidity):
- Place market orders or aggressive limits
- Pay taker fees (e.g., 0.05%)
- Go through JIT auction → DLOB → AMM
- Get filled immediately (or within auction duration)

Makers earn rebates as compensation for providing committed liquidity and bearing adverse selection risk.

## Order routing examples

**Example 1: Market order (long)**
1. Order enters JIT auction at oracle + 0.1%
2. Two JIT makers fill 60% at oracle + 0.02%
3. Remaining 40% fills against DLOB at oracle + 0.05%
4. AMM not needed (fully filled)

**Example 2: Large market order**
1. JIT auction fills 40% at oracle + 0.03%
2. DLOB fills 30% at oracle + 0.08%
3. AMM fills remaining 30% at oracle + 0.15% (price impact)

**Example 3: Limit order at DLOB price**
1. Order bypasses JIT (not crossing spread)
2. Rests on DLOB as maker order
3. Earns maker rebate when filled

## Optimizing execution

**For takers**:
- Market orders get best execution via JIT auction
- Large orders spread across multiple liquidity sources
- Consider splitting large orders to reduce AMM impact

**For makers**:
- Post resting orders on DLOB for passive fills + rebates
- Participate in JIT auctions for active market making
- Use oracle-offset orders to automatically follow market

**For both**:
- Monitor oracle validity (stale oracles can cause bad fills)
- Use appropriate order types (post-only for makers, market for takers)
- Consider slippage tolerance when sizing orders

## Liquidity depth

You can query available liquidity at each level:

**DLOB depth**:
```typescript
const orderbook = await fetch(
  "https://dlob.drift.trade/orderbook?marketIndex=0&marketType=perp"
).then(r => r.json());

console.log("Bids:", orderbook.bids);  // [[price, size], ...]
console.log("Asks:", orderbook.asks);
```

**AMM liquidity**:
```typescript
const perpMarket = driftClient.getPerpMarketAccount(0);
const ammReserves = perpMarket.amm;
// Calculate price impact for a given size
```

## Related

- [JIT Auctions](./jit-auctions) - Deep dive on auction mechanism
- [DLOB Architecture](./dlob-architecture) - How DLOB aggregates orders
- [Normal MM](/developers/market-makers/normal-mm) - Market making strategies
